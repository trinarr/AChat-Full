<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://xamarin.com/schemas/2014/forms"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:ffsvg="clr-namespace:FFImageLoading.Svg.Forms;assembly=FFImageLoading.Svg.Forms"
             x:Class="AChatFull.Views.ContactsPage"
             Title="Контакты"
             x:Name="ThisPage">

    <NavigationPage.TitleView>
        <Grid Padding="8" ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto">
            <!-- Кнопка Назад (видна только в режиме поиска) -->
            <Grid Grid.Column="0"
      WidthRequest="24" HeightRequest="24"
      BackgroundColor="Transparent"
      Margin="0,0,8,0"
      HorizontalOptions="Start"
      IsVisible="{Binding IsSearchMode}"
      VerticalOptions="Center">
                <ffsvg:SvgCachedImage
                    Aspect="AspectFit"
                    WidthRequest="24"
                    HeightRequest="24"
                    Source="resource://AChatFull.Resources.Icons.arrow_back.png?assembly=AChatFull" />
                <Grid.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnSearchBackClicked" />
                </Grid.GestureRecognizers>
            </Grid>

            <!-- Заголовок (виден, когда НЕ в режиме поиска) -->
            <Label Grid.Column="1"
             Text="Контакты"
             TextColor="#fff"
             FontAttributes="Bold"
             FontSize="18"
             VerticalTextAlignment="Center"
             IsVisible="{Binding IsSearchMode, Converter={StaticResource InverseBoolConverter}}" />

            <!-- Поле поиска (видимо только в режиме поиска) -->
            <Entry x:Name="SearchEntry"
                   Grid.Column="1"
                   Placeholder="Поиск"
                   Text="{Binding SearchText}"
                   ClearButtonVisibility="WhileEditing"
                   IsVisible="{Binding IsSearchMode}"
                   VerticalOptions="Center" />

            <!-- Иконка поиска (видима, когда НЕ в режиме поиска) -->
            <ImageButton Grid.Column="2"
                   Source="search.png"
                   WidthRequest="24" HeightRequest="24"
                   BackgroundColor="Transparent"
                   VerticalOptions="Center"
                   IsVisible="{Binding IsSearchMode, Converter={StaticResource InverseBoolConverter}}"
                   Clicked="OnSearchIconClicked" />
        </Grid>
    </NavigationPage.TitleView>

    <ContentPage.Content>
        <StackLayout>
            <!-- Переключатели сортировки -->
            <Grid Padding="12" ColumnDefinitions="*,*" >
                <Button Text="По имени" Command="{Binding SortByNameCommand}" />
                <Button Grid.Column="1" Text="По заходу" Command="{Binding SortByLastSeenCommand}" />
            </Grid>

            <CollectionView ItemsSource="{Binding Items}"
                      SelectionMode="None">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Grid Padding="15,4,15,4" ColumnDefinitions="60,*,Auto">
                            <Frame WidthRequest="40" HeightRequest="40" HasShadow="False" VerticalOptions="Start">
                                <Label Text="{Binding UserName, Converter={StaticResource FirstLetterConverter}}" TextColor="#333" FontSize="Medium"/>
                            </Frame>
                            <Grid ColumnSpacing="10" Grid.Column="1">
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer
                                        Command="{Binding BindingContext.OpenChatCommand, Source={x:Reference ThisPage}}"
                                        CommandParameter="{Binding .}" />
                                </Grid.GestureRecognizers>

                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                <!-- Аватар -->
                                <Frame
                                Grid.Column="0"
                                BackgroundColor="#CCCCCC"
                                HasShadow="False"
                                WidthRequest="48" 
                                HeightRequest="48"
                                CornerRadius="24"
                                Padding="0"
                                IsClippedToBounds="True"
                                VerticalOptions="Center">
                                    <Image
                                    Source=""
                                    Aspect="AspectFill" />
                                </Frame>
                                <StackLayout Grid.Column="1" Spacing="2" VerticalOptions="Center">
                                    <Label x:Name="NameFirstLetter" Text="{Binding UserName}" FontAttributes="Bold" TextColor="#000" FontSize="Medium" />
                                    <Label Text="был(а) в 14:05" TextColor="#666" FontSize="Small" />
                                </StackLayout>
                            </Grid>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </StackLayout>
    </ContentPage.Content>
</ContentPage>
