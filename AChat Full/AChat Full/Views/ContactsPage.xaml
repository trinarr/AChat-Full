<ContentPage xmlns="http://xamarin.com/schemas/2014/forms"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="AChatFull.Views.ContactsPage"
             x:Name="ThisPage"
             Padding="0"
             Title="Контакты">

    <NavigationPage.TitleView>
        <ContentView Padding="0">
            <Grid Padding="8" ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto">
                <ImageButton Grid.Column="0"
                     Source="arrow_back.png"
                     BackgroundColor="Transparent"
                     HeightRequest="24" WidthRequest="24"
                     Margin="0,0,8,0"
                     IsVisible="{Binding IsSearchMode}"
                     Clicked="OnSearchBackClicked" />

                <Label Grid.Column="1"
             Text="Контакты"
             TextColor="#fff"
             FontAttributes="Bold"
             FontSize="18"
             VerticalTextAlignment="Center"
             IsVisible="{Binding IsSearchMode, Converter={StaticResource InverseBoolConverter}}"/>

                <Entry x:Name="SearchEntry"
               Grid.Column="1"
               Placeholder="Поиск по пользователям"
               Text="{Binding SearchText}"
               ClearButtonVisibility="WhileEditing"
               ReturnType="Search"
               VerticalOptions="Center"
               IsVisible="{Binding IsSearchMode}" />

                <ImageButton Grid.Column="2"
                     Source="search.png"
                     HeightRequest="24" WidthRequest="24"
                     BackgroundColor="Transparent"
                     VerticalOptions="Center"
                     Clicked="OnSearchIconClicked">
                    <ImageButton.Triggers>
                        <DataTrigger TargetType="ImageButton" Binding="{Binding IsSearchMode}" Value="True">
                            <Setter Property="IsVisible" Value="False"/>
                        </DataTrigger>
                    </ImageButton.Triggers>
                </ImageButton>
            </Grid>
        </ContentView>
    </NavigationPage.TitleView>

    <ContentPage.Content>
        <Grid RowDefinitions="*"
          Padding="0"
          Margin="0">
            <CollectionView x:Name="ContactsList"
                      Grid.Row="0"
                      ItemsSource="{Binding Contacts}"
                      VerticalOptions="FillAndExpand"
                      SelectionMode="None">
                <CollectionView.Triggers>
                    <DataTrigger TargetType="CollectionView" Binding="{Binding IsSearchMode}" Value="True">
                        <Setter Property="IsVisible" Value="False"/>
                    </DataTrigger>
                    <DataTrigger TargetType="CollectionView" Binding="{Binding IsSearchMode}" Value="False">
                        <Setter Property="IsVisible" Value="True"/>
                    </DataTrigger>
                </CollectionView.Triggers>
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Grid Padding="12,8" ColumnDefinitions="56,*,Auto">
                            <Frame Grid.Column="0"
                     WidthRequest="48" HeightRequest="48"
                     CornerRadius="24"
                     Padding="0"
                     HasShadow="False"
                     IsClippedToBounds="True"
                     BackgroundColor="#E6E6E6"
                     HorizontalOptions="Start"
                     VerticalOptions="Center">
                                <Grid>
                                    <Image Source="{Binding AvatarUrl}"
                         Aspect="AspectFill"
                         IsVisible="{Binding HasAvatar}" />
                                    <Label Text="{Binding Initials}"
                         IsVisible="{Binding NoAvatar}"
                         HorizontalOptions="Center"
                         VerticalOptions="Center"
                         FontAttributes="Bold"
                         FontSize="Medium"
                         TextColor="#333"/>
                                </Grid>
                            </Frame>
                            <Grid Grid.Column="1"
                    RowDefinitions="Auto,Auto"
                    MinimumHeightRequest="48"
                    VerticalOptions="Center">
                                <Label Grid.Row="0"
                       Text="{Binding DisplayName}"
                       FontAttributes="Bold"
                       FontSize="Medium"
                       TextColor="#000"
                       VerticalOptions="Center">
                                    <Label.Triggers>
                                        <DataTrigger TargetType="Label" Binding="{Binding HasStatus}" Value="True">
                                            <Setter Property="VerticalOptions" Value="Start"/>
                                        </DataTrigger>
                                    </Label.Triggers>
                                </Label>
                                <Label Grid.Row="1"
                       Text="{Binding DisplayStatus}"
                       FontSize="Small"
                       TextColor="#777"
                       IsVisible="{Binding HasStatus}" />
                            </Grid>
                            <Grid Grid.ColumnSpan="2">
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding BindingContext.OpenChatCommand, Source={x:Reference ThisPage}}"
                                        CommandParameter="{Binding .}"/>
                                </Grid.GestureRecognizers>
                            </Grid>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
            <CollectionView x:Name="ResultsList"
                      Grid.Row="0"
                      ItemsSource="{Binding SearchGroups}"
                      IsGrouped="True"
                      SelectionMode="None"
                      VerticalOptions="FillAndExpand">
                <CollectionView.Triggers>
                    <DataTrigger TargetType="CollectionView" Binding="{Binding IsSearchMode}" Value="True">
                        <Setter Property="IsVisible" Value="True"/>
                    </DataTrigger>
                    <DataTrigger TargetType="CollectionView" Binding="{Binding IsSearchMode}" Value="False">
                        <Setter Property="IsVisible" Value="False"/>
                    </DataTrigger>
                </CollectionView.Triggers>
                <CollectionView.GroupHeaderTemplate>
                    <DataTemplate>
                        <Grid Padding="15,8">
                            <Label Text="{Binding Title}" FontAttributes="Bold" FontSize="Small" TextColor="#666"/>
                        </Grid>
                    </DataTemplate>
                </CollectionView.GroupHeaderTemplate>
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Grid Padding="12,8" ColumnDefinitions="56,*,Auto">
                            <Frame Grid.Column="0"
                     WidthRequest="48" HeightRequest="48"
                     CornerRadius="24"
                     Padding="0"
                     HasShadow="False"
                     IsClippedToBounds="True"
                     BackgroundColor="#E6E6E6"
                     HorizontalOptions="Start"
                     VerticalOptions="Center">
                                <Grid>
                                    <Image Source="{Binding AvatarUrl}"
                         Aspect="AspectFill"
                         IsVisible="{Binding HasAvatar}" />
                                    <Label Text="{Binding Initials}"
                         IsVisible="{Binding NoAvatar}"
                         HorizontalOptions="Center"
                         VerticalOptions="Center"
                         FontAttributes="Bold"
                         FontSize="Medium"
                         TextColor="#333"/>
                                </Grid>
                            </Frame>

                            <Grid Grid.Column="1"
                    RowDefinitions="Auto,Auto"
                    MinimumHeightRequest="48"
                    VerticalOptions="Center">
                                <Label Grid.Row="0"
                       Text="{Binding DisplayName}"
                       FontAttributes="Bold"
                       FontSize="Medium"
                       TextColor="#000"
                       VerticalOptions="Center">
                                    <Label.Triggers>
                                        <DataTrigger TargetType="Label" Binding="{Binding HasStatus}" Value="True">
                                            <Setter Property="VerticalOptions" Value="Start"/>
                                        </DataTrigger>
                                    </Label.Triggers>
                                </Label>

                                <Label Grid.Row="1"
                       Text="{Binding DisplayStatus}"
                       FontSize="Small"
                       TextColor="#777"
                       IsVisible="{Binding HasStatus}" />
                            </Grid>
                            <Grid Grid.ColumnSpan="2">
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding BindingContext.OpenChatCommand, Source={x:Reference ThisPage}}"
                                        CommandParameter="{Binding .}"/>
                                </Grid.GestureRecognizers>
                            </Grid>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Grid>
    </ContentPage.Content>
</ContentPage>