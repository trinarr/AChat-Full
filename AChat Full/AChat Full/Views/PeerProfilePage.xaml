<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="AChatFull.Views.PeerProfilePage"
    xmlns="http://xamarin.com/schemas/2014/forms"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:ios="clr-namespace:Xamarin.Forms.PlatformConfiguration.iOSSpecific;assembly=Xamarin.Forms.Core"
    ios:Page.UseSafeArea="True"
    NavigationPage.HasNavigationBar="False"
    BackgroundColor="#F3F4F6">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Кнопки быстрых действий -->
            <Style x:Key="CircleButton" TargetType="Frame">
                <Setter Property="WidthRequest" Value="64" />
                <Setter Property="HeightRequest" Value="64" />
                <Setter Property="CornerRadius" Value="32" />
                <Setter Property="Padding" Value="0" />
                <Setter Property="HasShadow" Value="False" />
                <Setter Property="BackgroundColor" Value="White" />
                <Setter Property="BorderColor" Value="#E5E7EB" />
                <Setter Property="HorizontalOptions" Value="Center" />
                <Setter Property="VerticalOptions" Value="Center" />
            </Style>
            <Style x:Key="ActionIcon" TargetType="Image">
                <Setter Property="WidthRequest" Value="28"/>
                <Setter Property="HeightRequest" Value="28"/>
                <Setter Property="HorizontalOptions" Value="Center"/>
                <Setter Property="VerticalOptions" Value="Center"/>
            </Style>
            <Style x:Key="ActionLabel" TargetType="Label">
                <Setter Property="FontSize" Value="12" />
                <Setter Property="TextColor" Value="#4B5563" />
                <Setter Property="HorizontalTextAlignment" Value="Center" />
            </Style>

            <!-- Белые карточки -->
            <Style x:Key="Card" TargetType="Frame">
                <Setter Property="CornerRadius" Value="16" />
                <Setter Property="HasShadow" Value="False" />
                <Setter Property="Padding" Value="16" />
                <Setter Property="Margin" Value="16,8,16,0" />
                <Setter Property="BackgroundColor" Value="#FFFFFF" />
            </Style>

            <!-- Стиль строки раздела: иконка + контент -->
            <Style x:Key="SectionRow" TargetType="Grid">
                <Setter Property="ColumnDefinitions">
                    <Setter.Value>
                        <ColumnDefinitionCollection>
                            <ColumnDefinition Width="36"/>
                            <ColumnDefinition Width="*" />
                        </ColumnDefinitionCollection>
                    </Setter.Value>
                </Setter>
                <Setter Property="RowSpacing" Value="0"/>
                <Setter Property="Padding" Value="0,8" />
            </Style>
            <Style x:Key="SectionIcon" TargetType="Image">
                <Setter Property="WidthRequest" Value="28"/>
                <Setter Property="HeightRequest" Value="28"/>
                <Setter Property="Opacity" Value="0.85"/>
                <Setter Property="HorizontalOptions" Value="Start"/>
                <Setter Property="VerticalOptions" Value="Center"/>
                <Setter Property="Margin" Value="6,2,8,0"/>
            </Style>
            <Style x:Key="SectionTitle" TargetType="Label">
                <Setter Property="FontSize" Value="16"/>
                <Setter Property="TextColor" Value="#111827"/>
            </Style>
            <Style x:Key="SectionValue" TargetType="Label">
                <Setter Property="FontSize" Value="14"/>
                <Setter Property="TextColor" Value="#6B7280"/>
            </Style>
            <Style x:Key="SectionDivider" TargetType="BoxView">
                <Setter Property="HeightRequest" Value="1"/>
                <Setter Property="BackgroundColor" Value="#E5E7EB"/>
                <Setter Property="Margin" Value="0,8"/>
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <!-- Контент + плавающие кнопки -->
    <Grid>

        <ScrollView>
            <StackLayout Spacing="0" Padding="0,0,0,24" BackgroundColor="#F3F4F6">

                <!-- Верх: аватар + имя + кастомный статус -->
                <Grid Padding="0,24,0,16" BackgroundColor="#F3F4F6">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="12"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="4"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Аватар со статусом -->
                    <Grid Grid.Row="0" HorizontalOptions="Center" VerticalOptions="Center">
                        <Frame WidthRequest="180" HeightRequest="180"
                               CornerRadius="90" Padding="0" HasShadow="False"
                               BackgroundColor="#E5E7EB">
                            <Grid>
                                <Image Source="{Binding AvatarImage}" Aspect="AspectFill" IsVisible="{Binding HasAvatar}"/>
                                <Label Text="{Binding Initials}"
                                       IsVisible="{Binding HasAvatar, Converter={StaticResource InverseBoolConverter}}"
                                       HorizontalOptions="Center" VerticalOptions="Center"
                                       FontSize="48" FontAttributes="Bold" TextColor="#374151"/>
                            </Grid>
                        </Frame>
                        <!-- Индикатор присутствия -->
                        <Grid WidthRequest="24" HeightRequest="24" HorizontalOptions="End" VerticalOptions="End" Margin="12">
                            <Frame HasShadow="False" Padding="0" WidthRequest="24" HeightRequest="24"
                                   CornerRadius="12" BackgroundColor="#F3F4F6"/>
                            <Frame HasShadow="False" Padding="0" WidthRequest="18" HeightRequest="18"
                                   CornerRadius="9" HorizontalOptions="Center" VerticalOptions="Center"
                                   BackgroundColor="{Binding Presence, Converter={StaticResource PresenceToColorConverter}}"/>
                        </Grid>
                    </Grid>

                    <Label Grid.Row="2" Text="{Binding FullName}" FontSize="24" FontAttributes="Bold"
                           HorizontalOptions="Center" TextColor="#111827"/>

                    <Label Grid.Row="4" Text="{Binding StatusCustom}" IsVisible="{Binding ShowCustomStatus}"
                           FontSize="14" LineBreakMode="TailTruncation"
                           HorizontalOptions="Center" TextColor="#6B7280"/>
                </Grid>

                <!-- Быстрые действия (без подложки) -->
                <Grid Padding="24,8" ColumnSpacing="24" BackgroundColor="#F3F4F6" Margin="0,0,0,8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <StackLayout Grid.Column="0" Spacing="8" HorizontalOptions="Center">
                        <Frame Style="{StaticResource CircleButton}">
                            <Grid>
                                <Image Style="{StaticResource ActionIcon}" Source="tab_chat.png"/>
                            </Grid>
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnMessageTapped"/>
                            </Frame.GestureRecognizers>
                        </Frame>
                        <Label Text="Message" Style="{StaticResource ActionLabel}"/>
                    </StackLayout>

                    <StackLayout Grid.Column="1" Spacing="8" HorizontalOptions="Center">
                        <Frame Style="{StaticResource CircleButton}">
                            <Grid>
                                <Image Style="{StaticResource ActionIcon}" Source="header_call_black.png"/>
                            </Grid>
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnVoiceTapped"/>
                            </Frame.GestureRecognizers>
                        </Frame>
                        <Label Text="Voice Call" Style="{StaticResource ActionLabel}"/>
                    </StackLayout>

                    <StackLayout Grid.Column="2" Spacing="8" HorizontalOptions="Center">
                        <Frame Style="{StaticResource CircleButton}">
                            <Grid>
                                <Image Style="{StaticResource ActionIcon}" Source="header_video_black.png"/>
                            </Grid>
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnVideoTapped"/>
                            </Frame.GestureRecognizers>
                        </Frame>
                        <Label Text="Video Call" Style="{StaticResource ActionLabel}"/>
                    </StackLayout>
                </Grid>

                <!-- Персональная информация: белая карточка, строки "подзаголовок + значение + иконка" -->
                <Frame Style="{StaticResource Card}" IsVisible="False">
                    <Frame.Triggers>
                        <!-- Карточка видима, если есть хотя бы одно из полей -->
                        <DataTrigger TargetType="Frame" Binding="{Binding ShowAbout}" Value="True">
                            <Setter Property="IsVisible" Value="True"/>
                        </DataTrigger>
                        <DataTrigger TargetType="Frame" Binding="{Binding ShowBirthdate}" Value="True">
                            <Setter Property="IsVisible" Value="True"/>
                        </DataTrigger>
                    </Frame.Triggers>

                    <StackLayout Spacing="0">
                        <!-- About -->
                        <Grid Style="{StaticResource SectionRow}" IsVisible="{Binding ShowAbout}">
                            <Image Source="info.png" Style="{StaticResource SectionIcon}"/>
                            <StackLayout Grid.Column="1" Spacing="2">
                                <Label Text="About" Style="{StaticResource SectionTitle}"/>
                                <Label Text="{Binding About}" Style="{StaticResource SectionValue}" LineBreakMode="WordWrap"/>
                            </StackLayout>
                        </Grid>

                        <!-- Divider между About и Birthdate: показывать только если есть оба поля -->
                        <BoxView Style="{StaticResource SectionDivider}"
                                 IsVisible="{Binding ShowAboutBirthdateDivider}" />

                        <!-- Birthdate -->
                        <Grid Style="{StaticResource SectionRow}" IsVisible="{Binding ShowBirthdate}">
                            <Image Source="birthday.png" Style="{StaticResource SectionIcon}"/>
                            <StackLayout Grid.Column="1" Spacing="2">
                                <Label Text="Birth date" Style="{StaticResource SectionTitle}"/>
                                <Label Text="{Binding BirthdateFormatted}" Style="{StaticResource SectionValue}"/>
                            </StackLayout>
                        </Grid>
                    </StackLayout>
                </Frame>

            </StackLayout>
        </ScrollView>

        <!-- Плавающие кнопки: назад / меню -->
        <Grid Padding="16" VerticalOptions="Start" HorizontalOptions="FillAndExpand">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <ImageButton Grid.Column="0" Source="arrow_back_black.png"
                         WidthRequest="28" HeightRequest="28"
                         BackgroundColor="Transparent"
                         Clicked="OnBackTapped"
                         HorizontalOptions="Start" VerticalOptions="Start"/>

            <ImageButton Grid.Column="2" Source="header_more_black.png"
                         WidthRequest="28" HeightRequest="28"
                         BackgroundColor="Transparent"
                         Clicked="OnMoreTapped"
                         HorizontalOptions="End" VerticalOptions="Start"/>
        </Grid>

    </Grid>
</ContentPage>
