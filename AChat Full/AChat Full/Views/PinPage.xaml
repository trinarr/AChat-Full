<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://xamarin.com/schemas/2014/forms"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="AChatFull.Views.PinPage"
             BackgroundColor="White"
             NavigationPage.HasNavigationBar="False">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- статичные цвета -->
            <Color x:Key="PinFilledColor">#2962FF</Color>
            <Color x:Key="PinEmptyColor">#D3D9E1</Color>

            <!-- цифры; фиксированная высота, чтобы клавиатура не растягивалась -->
            <Style x:Key="KeyButton" TargetType="Button">
                <Setter Property="BackgroundColor" Value="Transparent"/>
                <Setter Property="BorderWidth" Value="0"/>
                <Setter Property="CornerRadius" Value="0"/>
                <Setter Property="FontSize" Value="36"/>
                <Setter Property="TextColor" Value="Black"/>
                <Setter Property="Padding" Value="0"/>
                <Setter Property="HeightRequest" Value="64"/>
            </Style>

            <Style x:Key="AuxLink" TargetType="Label">
                <Setter Property="TextColor" Value="#6F7A89"/>
                <Setter Property="HorizontalTextAlignment" Value="Center"/>
                <Setter Property="FontSize" Value="14"/>
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <!-- Вся страница: верх — текст и точки, низ — клавиатура -->
    <Grid Padding="24,140,24,36" RowSpacing="0" ColumnSpacing="0">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- "Введите PIN" -->
            <RowDefinition Height="30"/>
            <!-- отступ -->
            <RowDefinition Height="Auto"/>
            <!-- точки -->
            <RowDefinition Height="*"/>
            <!-- гибкий отступ (выдавливает клавиатуру вниз) -->
            <RowDefinition Height="Auto"/>
            <!-- клавиатура -->
            <RowDefinition Height="16"/>
            <!-- отступ -->
            <RowDefinition Height="12"/>
            <!-- нижний отступ -->
        </Grid.RowDefinitions>

        <!-- Заголовок над точками -->
        <Label Grid.Row="0"
           Text="{Binding TitleText}" 
           FontSize="24"
           FontAttributes="Bold"
           HorizontalTextAlignment="Center"
           TextColor="Black"/>

        <!-- Точки PIN -->
        <Grid Grid.Row="2" ColumnSpacing="14" HorizontalOptions="Center">
            <Grid.ColumnDefinitions>
                <ColumnDefinition/>
                <ColumnDefinition/>
                <ColumnDefinition/>
                <ColumnDefinition/>
            </Grid.ColumnDefinitions>

            <BoxView Grid.Column="0" HeightRequest="12" WidthRequest="12" CornerRadius="6"
               Color="{StaticResource PinEmptyColor}">
                <BoxView.Triggers>
                    <DataTrigger TargetType="BoxView" Binding="{Binding Dot1}" Value="True">
                        <Setter Property="Color" Value="{StaticResource PinFilledColor}"/>
                    </DataTrigger>
                </BoxView.Triggers>
            </BoxView>
            <BoxView Grid.Column="1" HeightRequest="12" WidthRequest="12" CornerRadius="6"
               Color="{StaticResource PinEmptyColor}">
                <BoxView.Triggers>
                    <DataTrigger TargetType="BoxView" Binding="{Binding Dot2}" Value="True">
                        <Setter Property="Color" Value="{StaticResource PinFilledColor}"/>
                    </DataTrigger>
                </BoxView.Triggers>
            </BoxView>
            <BoxView Grid.Column="2" HeightRequest="12" WidthRequest="12" CornerRadius="6"
               Color="{StaticResource PinEmptyColor}">
                <BoxView.Triggers>
                    <DataTrigger TargetType="BoxView" Binding="{Binding Dot3}" Value="True">
                        <Setter Property="Color" Value="{StaticResource PinFilledColor}"/>
                    </DataTrigger>
                </BoxView.Triggers>
            </BoxView>
            <BoxView Grid.Column="3" HeightRequest="12" WidthRequest="12" CornerRadius="6"
               Color="{StaticResource PinEmptyColor}">
                <BoxView.Triggers>
                    <DataTrigger TargetType="BoxView" Binding="{Binding Dot4}" Value="True">
                        <Setter Property="Color" Value="{StaticResource PinFilledColor}"/>
                    </DataTrigger>
                </BoxView.Triggers>
            </BoxView>
        </Grid>

        <!-- Клавиатура у нижнего края (Row=4), компактная -->
        <Grid Grid.Row="4" RowSpacing="18" ColumnSpacing="18" VerticalOptions="End">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition/>
                <ColumnDefinition/>
                <ColumnDefinition/>
            </Grid.ColumnDefinitions>

            <!-- 1..9 -->
            <Button Grid.Row="0" Grid.Column="0" Text="1" Style="{StaticResource KeyButton}"
              Command="{Binding NumberCommand}" CommandParameter="1"/>
            <Button Grid.Row="0" Grid.Column="1" Text="2" Style="{StaticResource KeyButton}"
              Command="{Binding NumberCommand}" CommandParameter="2"/>
            <Button Grid.Row="0" Grid.Column="2" Text="3" Style="{StaticResource KeyButton}"
              Command="{Binding NumberCommand}" CommandParameter="3"/>

            <Button Grid.Row="1" Grid.Column="0" Text="4" Style="{StaticResource KeyButton}"
              Command="{Binding NumberCommand}" CommandParameter="4"/>
            <Button Grid.Row="1" Grid.Column="1" Text="5" Style="{StaticResource KeyButton}"
              Command="{Binding NumberCommand}" CommandParameter="5"/>
            <Button Grid.Row="1" Grid.Column="2" Text="6" Style="{StaticResource KeyButton}"
              Command="{Binding NumberCommand}" CommandParameter="6"/>

            <Button Grid.Row="2" Grid.Column="0" Text="7" Style="{StaticResource KeyButton}"
              Command="{Binding NumberCommand}" CommandParameter="7"/>
            <Button Grid.Row="2" Grid.Column="1" Text="8" Style="{StaticResource KeyButton}"
              Command="{Binding NumberCommand}" CommandParameter="8"/>
            <Button Grid.Row="2" Grid.Column="2" Text="9" Style="{StaticResource KeyButton}"
              Command="{Binding NumberCommand}" CommandParameter="9"/>

            <!-- нижний ряд: отпечаток | 0 | backspace -->
            <!-- отпечаток: показываем, только если доступна биометрия -->
            <ImageButton Grid.Row="3" Grid.Column="0"
                   WidthRequest="32" HeightRequest="32"
                   BackgroundColor="Transparent" Padding="15"
                   Aspect="AspectFit" 
                   Source="fingerprint.png"
                   Command="{Binding BiometricsCommand}"
                   IsVisible="{Binding ShowBiometricButton}"/>
            
            <Button Grid.Row="3" Grid.Column="1" Text="0" Style="{StaticResource KeyButton}"
              Command="{Binding NumberCommand}" CommandParameter="0"/>

            <ImageButton Grid.Row="3" Grid.Column="2"
                   WidthRequest="32" HeightRequest="32"
                   BackgroundColor="Transparent" Padding="15"
                   Aspect="AspectFit"
                   Source="backspace.png"
                   Command="{Binding DeleteCommand}"/>
        </Grid>
    </Grid>
</ContentPage>