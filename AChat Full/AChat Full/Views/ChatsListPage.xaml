<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
  xmlns="http://xamarin.com/schemas/2014/forms"
  xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
  xmlns:vm="clr-namespace:AChatFull.Views"
  x:Class="AChatFull.Views.ChatsListPage"
  Title="Чаты"
  BackgroundColor="White">

    <NavigationPage.TitleView>
        <Grid Padding="8" ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto">
            <!-- Назад (только в режиме поиска) -->
            <ImageButton Grid.Column="0" Source="arrow_back.png"  BackgroundColor="Transparent"
                         HeightRequest="24" WidthRequest="24" Clicked="OnSearchBackClicked" 
                         Margin="0,0,8,0"
            HorizontalOptions="Start"
            VerticalOptions="Center"
            IsVisible="{Binding IsSearchMode}"/>

            <!-- Заголовок (когда НЕ поиск) -->
            <Label Grid.Column="1"
             Text="Чаты"
             TextColor="#fff"
             FontAttributes="Bold"
             FontSize="18"
             VerticalTextAlignment="Center"
             IsVisible="{Binding IsSearchMode, Converter={StaticResource InverseBoolConverter}}"/>

            <!-- Поле поиска (когда поиск) -->
            <Entry x:Name="SearchEntry"
             Grid.Column="1"
             TextColor="#fff"
             Placeholder="Поиск по чатам"
             Text="{Binding SearchText}"
             ClearButtonVisibility="WhileEditing"
             IsVisible="{Binding IsSearchMode}"
             VerticalOptions="Center"/>

            <!-- Иконка поиска (когда НЕ поиск) -->
            <ImageButton Grid.Column="2"
                   Source="search.png"
                   WidthRequest="24" HeightRequest="24"
                   BackgroundColor="Transparent"
                   VerticalOptions="Center"
                   IsVisible="{Binding IsSearchMode, Converter={StaticResource InverseBoolConverter}}"
                   Clicked="OnSearchIconClicked"/>
        </Grid>
    </NavigationPage.TitleView>

    <!-- Loader -->
    <StackLayout>
        <ActivityIndicator
      IsRunning="{Binding IsBusy}"
      IsVisible="{Binding IsBusy}"
      VerticalOptions="Center"
        HorizontalOptions="Center"
        WidthRequest="50"
        HeightRequest="50" 
            Color="Gray"/>

        <CollectionView
    ItemsSource="{Binding Chats}"
    SelectionMode="Single"
    SelectionChanged="OnChatSelected">
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="vm:ChatSummary">
                    <Frame
                        Padding="15,12"
                        Margin="5" 
                        CornerRadius="0">
                        <Grid ColumnSpacing="10">
                            <!-- Колонки: текст и время+статус -->
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                           <!-- Аватар -->
                            <Frame Grid.Column="0"
                     WidthRequest="48" HeightRequest="48"
                     CornerRadius="24"
                     Padding="0"
                     HasShadow="False"
                     IsClippedToBounds="True"
                     BackgroundColor="#E6E6E6"
                     HorizontalOptions="Start"
                     VerticalOptions="Center">
                                <Grid>
                                    <Image Source="{Binding PeerAvatarUrl}"
                         Aspect="AspectFill"
                         IsVisible="{Binding PeerHasAvatar}" />
                                    <Label Text="{Binding PeerInitials}"
                         IsVisible="{Binding PeerNoAvatar}"
                         HorizontalOptions="Center"
                         VerticalOptions="Center"
                         FontAttributes="Bold"
                         FontSize="Medium"
                         TextColor="#333"/>
                                </Grid>
                            </Frame>

                            <!-- Левый столбец: имя и последнее сообщение -->
                            <StackLayout 
                                Grid.Column="1" 
                                Spacing="2"
                                VerticalOptions="Center">
                                <Label
                                    Text="{Binding Title}"
                                    FontAttributes="Bold"
                                    FontSize="18"
                                    TextColor="#000" />
                                <Label
                                    Text="{Binding LastMessage}"
                                    FontSize="Small"
                                    LineBreakMode="TailTruncation"
                                    MaxLines="1"
                                    TextColor="#666" />   
                            </StackLayout>

                            <!-- Правый столбец: время и статус -->
                            <StackLayout
                                Grid.Column="2"
                                Spacing="4"
                                VerticalOptions="Start"
                                HorizontalOptions="End">
                                <Label
                                    Text="{Binding LastTimestamp, StringFormat='{0:HH:mm}'}"
                                    FontSize="Micro"
                                    TextColor="#999"
                                    HorizontalOptions="End"/>
                            </StackLayout>
                        </Grid>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>
    </StackLayout>
</ContentPage>