<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
  xmlns="http://xamarin.com/schemas/2014/forms"
  xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
  xmlns:vm="clr-namespace:AChatFull.Views"
  x:Class="AChatFull.Views.ChatsListPage"
  Title="Чаты"
  BackgroundColor="White">

    <NavigationPage.TitleView>
        <Grid Padding="8" ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto">
            <!-- Назад (только в режиме поиска) -->
            <ImageButton Grid.Column="0" Source="arrow_back.png"  BackgroundColor="Transparent"
                         HeightRequest="24" WidthRequest="24" Clicked="OnSearchBackClicked" 
                         Margin="0,0,8,0"
            HorizontalOptions="Start"
            VerticalOptions="Center"
            IsVisible="{Binding IsSearchMode}"/>

            <!-- Заголовок (когда НЕ поиск) -->
            <Label Grid.Column="1"
             Text="Chats"
             TextColor="#fff"
             FontAttributes="Bold"
             FontSize="18"
             VerticalTextAlignment="Center"
             HorizontalTextAlignment="Center"
             IsVisible="{Binding IsSearchMode, Converter={StaticResource InverseBoolConverter}}"/>

            <!-- Поле поиска (когда поиск) -->
            <Entry x:Name="SearchEntry"
             Grid.Column="1"
             TextColor="#fff"
             Placeholder="Search"
             Text="{Binding SearchText}"
             ClearButtonVisibility="WhileEditing"
             IsVisible="{Binding IsSearchMode}"
             VerticalOptions="Center"/>

            <!-- Иконка поиска (когда НЕ поиск) -->
            <ImageButton Grid.Column="2"
             Source="search.png" 
             HeightRequest="24" WidthRequest="24"
             BackgroundColor="Transparent"
             VerticalOptions="Center"
             IsVisible="{Binding IsSearchMode, Converter={StaticResource InverseBoolConverter}}"
             Clicked="OnSearchIconClicked"/>
        </Grid>
    </NavigationPage.TitleView>

    <StackLayout>
        <ActivityIndicator
      IsRunning="{Binding IsBusy}"
      IsVisible="{Binding IsBusy}"
      VerticalOptions="Center"
        HorizontalOptions="Center"
        WidthRequest="50"
        HeightRequest="50" 
            Color="Gray"/>

        <CollectionView
    ItemsSource="{Binding Chats}"
    SelectionMode="Single"
    SelectionChanged="OnChatSelected">
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="vm:ChatSummary">
                    <Frame
                      Padding="15,12"
                        Margin="5" 
                        CornerRadius="0">
                        <Grid ColumnSpacing="10">
                            <!-- Колонки: аватар, текст, время/счетчик -->
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <!-- Аватар + индикатор присутствия -->
                            <!-- Статус-иконка вместо аватарки -->
                            <Image Grid.Column="0"
       Source="{Binding Peer.Presence, Converter={StaticResource PresenceToImageConverter}}"
       WidthRequest="35" HeightRequest="35"
       HorizontalOptions="Start"
       VerticalOptions="Center"
       Aspect="AspectFit"/>

                            <!-- Центральная колонка: только ник -->
                            <StackLayout Grid.Column="1" Spacing="2" VerticalOptions="Center">
                                <Label Text="{Binding Title}"
         FontAttributes="Bold"
         FontSize="16"
         TextColor="#000"/>
                            </StackLayout>

                            <!-- Правый столбец -->
                            <StackLayout Grid.Column="2" Spacing="6"
                                VerticalOptions="Start"
                                HorizontalOptions="End">
                                <Label
                                    Text="{Binding LastTimestamp, StringFormat='{0:HH:mm}'}"
                                    FontSize="Micro"
                                    TextColor="#999"
                                    HorizontalOptions="End"/>
                            </StackLayout>
                        </Grid>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>
    </StackLayout>
</ContentPage>
