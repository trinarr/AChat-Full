<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://xamarin.com/schemas/2014/forms"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:AChatFull.Views"
    xmlns:conv="clr-namespace:AChatFull"
    x:Class="AChatFull.Views.ChatPage"
    BackgroundColor="White">

    <!-- Регистрируем локально InverseBoolConverter -->
    <ContentPage.Resources>
        <ResourceDictionary>
            <conv:InverseBoolConverter x:Key="InverseBoolConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <NavigationPage.TitleView>
        <Grid Padding="0" RowSpacing="0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <!-- аватар -->
                <ColumnDefinition Width="*" />
                <!-- текст -->
            </Grid.ColumnDefinitions>
            <!-- 2 строки для текста -->
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Аватар -->
            <Frame
        Grid.Column="0"
        Grid.RowSpan="2"
        WidthRequest="36" HeightRequest="36"
        CornerRadius="18"
        Padding="0"
        IsClippedToBounds="True"
        VerticalOptions="Center">
                <Image
          Source=""
          Aspect="AspectFill" />
            </Frame>

            <!-- Имя собеседника -->
            <Label
        Grid.Column="1"
        Grid.Row="0"
        Text="{Binding PeerName}"
        TextColor="White"
        FontAttributes="Bold"
        FontSize="Medium"
        VerticalOptions="End" />

            <!-- Статус (в сети, был(а) недавно и т.п.) -->
            <Label
        Grid.Column="1"
        Grid.Row="1"
        Text="{Binding PeerStatus}"
        TextColor="White"
        FontSize="Small"
        VerticalOptions="Start" />
        </Grid>
    </NavigationPage.TitleView>

    <Grid RowDefinitions="*,Auto" RowSpacing="0">

        <!-- 1) Секция сообщений -->
        <CollectionView
      x:Name="MessagesView"
      ItemsSource="{Binding Messages}"
      Grid.Row="0"
      BackgroundColor="White"
      Margin="0,0,0,0">
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="vm:ChatMessage">
                    <Grid Padding="8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <!-- Входящее (слева) -->
                        <Frame
              Grid.Column="0"
              BackgroundColor="#E0E0E0"
              Padding="10"
              CornerRadius="8"
              IsVisible="{Binding IsIncoming}"
              HorizontalOptions="Start">
                            <Label
                Text="{Binding Text}"
                TextColor="Black" />
                        </Frame>

                        <!-- Исходящее (справа) -->
                        <Frame
              Grid.Column="2"
              BackgroundColor="#0084FF"
              Padding="10"
              CornerRadius="8"
              IsVisible="{Binding IsIncoming, Converter={StaticResource InverseBoolConverter}}"
              HorizontalOptions="End">
                            <Label
                Text="{Binding Text}"
                TextColor="White" />
                        </Frame>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- 2) Фиксированная панель ввода внизу -->
        <Grid
      Grid.Row="1"
      Padding="8"
      BackgroundColor="White"
      ColumnSpacing="8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <Editor
                IsSpellCheckEnabled="true"
                x:Name="MessageEditor"
                Text="{Binding MessageText}"
                AutoSize="TextChanges"
                VerticalOptions="Start"
                Placeholder="Сообщение"
                Margin="0"/>

            <Button
        Text="Отправить"
        Command="{Binding SendCommand}"
        Grid.Column="1"
        VerticalOptions="Center" />
        </Grid>

    </Grid>
</ContentPage>