<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://xamarin.com/schemas/2014/forms"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:AChatFull.Views"
    xmlns:conv="clr-namespace:AChatFull.Utils"
    xmlns:ffsvg="clr-namespace:FFImageLoading.Svg.Forms;assembly=FFImageLoading.Svg.Forms"
    x:Class="AChatFull.Views.ChatPage"
    x:Name="PageRoot"
    BackgroundColor="White">

    <!-- Регистрируем локально InverseBoolConverter -->
    <ContentPage.Resources>
        <ResourceDictionary>
            <conv:InverseBoolConverter x:Key="InverseBoolConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <NavigationPage.TitleView>
        <Grid Padding="0" RowSpacing="0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>
            <!-- 2 строки для текста -->
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <Grid Grid.Column="0"
      Grid.RowSpan="2"
      WidthRequest="24" HeightRequest="24"
      BackgroundColor="Transparent"
      Margin="0,0,8,0"
      HorizontalOptions="Start"
      VerticalOptions="Center">
                <ffsvg:SvgCachedImage
        Aspect="AspectFit"
        WidthRequest="24"
        HeightRequest="24"
        Source="resource://AChatFull.Resources.Icons.arrow_back.png" />
                <Grid.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnBackClicked" />
                </Grid.GestureRecognizers>
            </Grid>

            <!-- Аватар -->
            <Frame
        Grid.Column="1"
        Grid.RowSpan="2"
        WidthRequest="36" HeightRequest="36"
        CornerRadius="18"
        Padding="0"
        IsClippedToBounds="True"
        VerticalOptions="Center">
                <Image
          Source=""
          Aspect="AspectFill" />
            </Frame>

            <!-- Имя собеседника -->
            <Label
        Grid.Column="2"
        Grid.Row="0"
        Text="{Binding PeerName}"
        TextColor="White"
        FontAttributes="Bold"
        FontSize="Medium"
        VerticalOptions="End" />

            <!-- Статус (в сети, был(а) недавно и т.п.) -->
            <Label
        Grid.Column="2"
        Grid.Row="1"
        Text="{Binding PeerStatus}"
        TextColor="White"
        FontSize="Small"
        VerticalOptions="Start" />
        </Grid>
    </NavigationPage.TitleView>

    <Grid RowDefinitions="*,Auto" RowSpacing="0">

        <!-- 1) Секция сообщений -->
        <CollectionView
      x:Name="MessagesView"
      ItemsSource="{Binding Messages}"
      Grid.Row="0"
      BackgroundColor="White"
      Margin="0,0,0,0">
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="vm:ChatMessage">
                    <Grid Padding="8">
                        <!-- Текст -->
                        <Frame Padding="10" CornerRadius="8" HasShadow="False"
             IsVisible="{Binding Kind, Converter={StaticResource EqualConverter}, ConverterParameter=Text}"
             HorizontalOptions="{Binding IsIncoming, Converter={StaticResource BoolToHorzOptionsConverter}}"
             BackgroundColor="{Binding IsIncoming, Converter={StaticResource IncomingBgConverter}}">
                            <Label Text="{Binding Text}" TextColor="{Binding IsIncoming, Converter={StaticResource IncomingTextColorConverter}}"
               LineBreakMode="WordWrap"/>
                        </Frame>

                        <!-- Документ -->
                        <Frame Padding="10" CornerRadius="8" HasShadow="False"
                               IsVisible="{Binding Kind, Converter={StaticResource EqualConverter}, ConverterParameter=Document}"
                               HorizontalOptions="{Binding IsIncoming, Converter={StaticResource BoolToHorzOptionsConverter}}"
                               BackgroundColor="{Binding IsIncoming, Converter={StaticResource IncomingBgConverter}}">
                            <Grid ColumnDefinitions="Auto,* ,Auto" RowDefinitions="Auto,Auto" ColumnSpacing="8">
                                <!-- иконка файла -->
                                <Image Grid.RowSpan="2" Grid.Column="0" Source="attachment.png" WidthRequest="24" HeightRequest="24" />

                                <!-- название -->
                                <Label Grid.Column="1" Grid.Row="0" Text="{Binding Document.FileName}" FontAttributes="Bold" LineBreakMode="TailTruncation"/>
                                <!-- размер -->
                                <Label Grid.Column="1" Grid.Row="1" Text="{Binding Document.FileSize, Converter={StaticResource FileSizeConverter}}" FontSize="Small" TextColor="Gray"/>

                                <!-- кнопка -->
                                <Button Grid.Column="2" Grid.RowSpan="2"
                  Text="{Binding Document.IsDownloaded, Converter={StaticResource BoolToTextConverter}, ConverterParameter='Открыть|Скачать'}"
                   Command="{Binding Source={x:Reference PageRoot}, Path=BindingContext.OpenDocumentCommand}"
                  CommandParameter="{Binding}" />

                                <!-- прогресс -->
                                <ProgressBar Grid.ColumnSpan="3" Grid.Row="2" Margin="0,8,0,0"
                       IsVisible="{Binding Document.IsDownloading}"
                       Progress="{Binding Document.Progress}" />
                            </Grid>
                        </Frame>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- 2) Фиксированная панель ввода внизу -->
        <Grid
      Grid.Row="1"
      Padding="8"
      BackgroundColor="White"
      ColumnSpacing="8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- скрепка -->
            <ImageButton Grid.Column="0"
               Source="attach_file.png"
               BackgroundColor="Transparent"
               Command="{Binding AttachDocumentCommand}"
               WidthRequest="28" HeightRequest="28" />

            <Editor
                Grid.Column="1"
                IsSpellCheckEnabled="true"
                x:Name="MessageEditor"
                Text="{Binding MessageText}"
                AutoSize="TextChanges"
                VerticalOptions="Start"
                Placeholder="Сообщение"
                Margin="0"/>

            <Button Grid.Column="2"
        Text="Отправить"
        Command="{Binding SendCommand}"
        VerticalOptions="Center" />
        </Grid>

    </Grid>
</ContentPage>