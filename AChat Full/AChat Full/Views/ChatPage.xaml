<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="AChatFull.Views.ChatPage"
    xmlns="http://xamarin.com/schemas/2014/forms"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:ffsvg="clr-namespace:FFImageLoading.Svg.Forms;assembly=FFImageLoading.Svg.Forms">

    <Grid RowDefinitions="Auto,*,Auto" RowSpacing="0">

        <Grid Grid.Row="0" Padding="8" ColumnSpacing="15" BackgroundColor="#1E88E5">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <ImageButton Grid.Column="0" Source="arrow_back.png"  BackgroundColor="Transparent"
                         HeightRequest="24" WidthRequest="24" Clicked="OnBackClicked" />

            <!-- СТАЛО -->
            <AbsoluteLayout Grid.Column="1"
                WidthRequest="36" HeightRequest="36"
                HorizontalOptions="Start"
                VerticalOptions="Center">

                <!-- Круглый аватар (как и был) -->
                <Frame Padding="0"
           WidthRequest="36" HeightRequest="36"
           CornerRadius="18"
           HasShadow="False"
           IsClippedToBounds="True"
           BackgroundColor="#E6E6E6"
           AbsoluteLayout.LayoutBounds="0,0,1,1"
           AbsoluteLayout.LayoutFlags="All">
                    <Grid>
                        <Image Source="{Binding PeerAvatarUrl}"
                   Aspect="AspectFill"
                   IsVisible="{Binding PeerHasAvatar}" />
                        <Label Text="{Binding PeerInitials}"
                   IsVisible="{Binding PeerNoAvatar}"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"
                   FontAttributes="Bold"
                   FontSize="16"
                   TextColor="#333"/>
                    </Grid>
                </Frame>

                <!-- Индикатор статуса поверх, справа-снизу -->
                <Grid InputTransparent="True"
          AbsoluteLayout.LayoutBounds="1,1,14,14"
          AbsoluteLayout.LayoutFlags="PositionProportional">
                    <!-- белый ободок -->
                    <Frame WidthRequest="14" HeightRequest="14"
               CornerRadius="7"
               Padding="0"
               BackgroundColor="White"
               HasShadow="False"/>
                    <!-- цвет статуса -->
                    <Frame WidthRequest="10" HeightRequest="10"
               CornerRadius="5"
               Padding="0"
               HasShadow="False"
               HorizontalOptions="Center"
               VerticalOptions="Center"
               BackgroundColor="{Binding Peer.Presence, Converter={StaticResource PresenceToColorConverter}}"/>
                </Grid>
            </AbsoluteLayout>

            <StackLayout Grid.Column="2" Spacing="0" VerticalOptions="Center">
                <Label Text="{Binding PeerName}" FontAttributes="Bold" FontSize="16" LineBreakMode="TailTruncation" TextColor="#fff"/>
                <Label Text="{Binding PeerStatus}" FontSize="12" TextColor="#fff"/>
            </StackLayout>

            <ImageButton Grid.Column="3" Source="header_call.png"  BackgroundColor="Transparent"
                         HeightRequest="24" WidthRequest="24" Clicked="OnAudioCallClicked" />
            <ImageButton Grid.Column="4" Source="header_video.png" BackgroundColor="Transparent"
                         HeightRequest="24" WidthRequest="24" Clicked="OnVideoCallClicked" />
            <ImageButton Grid.Column="5" Source="header_more.png"  BackgroundColor="Transparent"
                         HeightRequest="24" WidthRequest="24" Clicked="OnMoreClicked" />
        </Grid>

        <ContentView x:Name="MessagesHost" Grid.Row="1" />

        <Grid Grid.Row="1" IsVisible="{Binding IsMessagesLoading}" BackgroundColor="#40FFFFFF">
            <ActivityIndicator IsRunning="True" VerticalOptions="Center" HorizontalOptions="Center" />
        </Grid>

        <Grid Grid.Row="2" Padding="8" BackgroundColor="White" ColumnSpacing="8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <ImageButton Grid.Column="0" Source="attach_file.png"
                         BackgroundColor="Transparent"
                         Command="{Binding AttachDocumentCommand}"
                         WidthRequest="28" HeightRequest="28" />

            <Editor Grid.Column="1"
                    x:Name="MessageEditor"
                    Text="{Binding MessageText}"
                    AutoSize="TextChanges"
                    Placeholder="Message"/>

            <Button Grid.Column="2"
                    Text="Send"
                    Command="{Binding SendCommand}"
                    VerticalOptions="Center"/>
        </Grid>

    </Grid>
</ContentPage>